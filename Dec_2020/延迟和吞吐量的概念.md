# 网络延迟和吞吐量的概念

参考文献：计算机网络：自顶向下方法

## 延迟

当一个分组从一个节点（路由器或者主机）到另一个节点的过程存在时延。一般来说，时延包括：

- 节点处理延迟：路由器检查分组首部和决定其去向，通常是us级别
- 排队延迟：分组在链路中等待传输时，需要排队的延迟。排队延迟受发送速率与带宽的比值和竞争流的影响
- 传输延迟：等于**分组长度/链路传输速率**。它是路由器将所有分组的比特发射到链路的时间
- 传播延迟：从路由器A到路由器B传播的时间，一般是两个节点的**物理距离/光速**

因此一个分组通过一个节点到达另一个节点的总时延为：
$$
d_{all} = d_{proc}+d_{que}+d_{trans}+d_{prop} 
$$
节点处理延迟基本可以忽略，在局域网或者校园网测试时，传播延迟也可以忽略。因此一个分组在两台主机之间的端到端延迟只包括排队延迟和传输延迟。

ps.传输时延是路由器发射分组需要的时间，传播时延是两台路由器之间距离的函数，与分组长度和链路传输速率无关。可以理解为链路传输速率实际是路由器交换数据的速率。

### 传输延迟

仅当路由器已经接收完一个分组的所有比特后，它才能开始向链路传输该分组。考虑一般情况，源端通过由N条速率均为R的链路组成的路径（路径上有N-1个路由器）向目的地发送一个分组。分组长度为**L** bit，链路传输速率为**R** bps。那么一个分组的端到端时延为：
$$
d_{e2e} = N*\frac{L}{R}
$$

### 排队延迟

一个特定分组的排队延迟取决于队列中正在排队的分组个数。如果队列为空，则排队延迟为0。如果数据速率很大，而且存在多条流通过相同链路，则排队延迟会很长。

排队延迟对每个分组是不同的，如果5个分组同时达到空队列，最后一个传输的分组排队延迟最高。因此通常用统计量表征排队延迟，比如平均排队延迟，方差和排队延迟超过特定值的概率。

排队延迟取决于**分组到达队列的速率、链路传输速率和到达流量的性质**，即流量是周期性到达还是突发到达。假设分组到达速率为**a**分组/秒，链路速率为**R** bps, L bit为分组长度。定义流量强度为**La/R**，如果流量强度大于1，那么排队的数据包会无限增加，排队延迟趋向无穷大。

如果**La/R<=1**，到达流量的性质影响排队延迟。如果分组按照规律性周期到达，那么排队延迟为0。但是如果分组突发性到达，排队延迟仍会存在并增加。假设每(L/R)N秒有N个分组到达，那么除了第一个分组外都有排队延迟。通常到达队列的时间是随机的，分组之间的时间间隔也是随机的。（ps.但是平均到达时间间隔可以视为常量？表征接收速率）。当流量强度接近1时，到达速率可能超过传输速率，因此将形成队列。

随着流量强度接近1，平均排队延迟迅速增加。该强度的少量增加将导致时延大比例增加。平均排队延迟和流量强度的关系类似指数增长曲线。

一个Java交互小游戏：[queue delay game](https://media.pearsoncmg.com/ph/esm/ecs_kurose_compnetwork_8/cw/content/interactiveanimations/queuing-loss-applet/index.html)

## 网络吞吐量

从主机A发送一个大文件到主机B，瞬时吞吐量是主机B收到该文件的速率。如果主机接收F比特用了T秒，则平均吞吐量为F/T bps。

考虑从一个服务端发送文件到一个客户端。如果两者之间存在N条链路，这N条链路的传输速率依次是R1,R2, ... Rn，那么传输的吞吐量为min{R1,...Rn}，这也是瓶颈链路的速率，即网络带宽。目前因特网对吞吐量的限制因素通常是接入网。吞吐量不仅取决于数据流过的链路的传输速率，也取决于在同一条链路上竞争的流量。

## 思考

在大块文件传输时，RTT的大小不再重要，因为传输总时间就是吞吐量/文件大小。排队延迟只影响每个包的到达时间，但是不影响一整块数据的传输时间。因此CUBIC很适合大文件传输，因为它可以占满网络容量。

在交互式应用下，需要低的RTT。尽管使用CUBIC，吞吐量可以到达网络容量，但是排队延迟很大。如果接收端发起交互，那么发送端的交互数据需要等待很长的排队延迟（因为队列中已经存在排队数据）才能到达接收端，这样就增大了交互延迟。

为了保证交互式应用的效果，需要设计低延迟的算法。将控制点控制在buffer-limit阶段，控制RTT在特定阈值内，这样既保证充分利用网络容量，也控制了交互延迟。这样的算法可以在蜂窝移动网络中部署，因为不用考虑和loss-based的交叉流竞争。

基于延迟的算法同时可以解决移动网络的随机丢包和高度变化带宽的问题。因为这种算法将延迟视为拥塞信号，对丢包不敏感；始终保持网络队列中存在一定的排队数据，保证充分利用链路带宽。

