# 04-19 面试

### 媒体融合网络项目

任务：在边缘服务器和移动终端之间构建低延迟视频传输协议。完成视频的低延迟传输和双端交互

分析：比较多个协议，采用轻量化的QUIC协议，基于cloudfare开源的quiche仓库实现

实施：

- 在发送端：
  - 基于libev实现实时视频传输的回调函数。(**libev**)
  - 将quiche server改写为一个c++类，在主函数中作为子线程调用，对外的接口为init和loop函数，init初始化接口，loop进入发送循环。这样可以直接从内存中读取数据发送，还可以将从client端反馈的信令传给其他子线程处理。 (**Thread**)
  - 信令反馈方法：在class sever中定义一个静态成员变量，在成员函数中赋值，主程序只需要调用这个变量即可。
- 在客户端：
  - 实现视频接收功能
  - 交互功能：将键盘输入的字符作为指令传输给server (**termios.h**)
  - 目前的改进：去除libev等依赖，将quiche api封装为类似socket编程的类，包括init, recv, send 和 timeout函数
- 遇到的问题：客户端播放视频出现卡顿花屏。分析可能是传输过程有丢包，分别在server和client保存视频，对比大小无问题。再怀疑是传输视频数据不及时，打印视频发送函数每次调用和完成发送一帧的时间戳和编码器出来一帧的时间戳，发现无问题。最后考虑是不是ffplay缓冲区的问题，加入infbuf标志位后，不限制buffer大小，为实时流提供。

### 网络指标测试

最主要的是测量视频每一帧的延迟

- 时间同步：ntp同步（4个时间戳，假设往返两个单向延迟相等）修改客户端的ntp.conf文件，输入服务器地址。如果在跨网的环境下，利用zerotier内网穿透，提供一个ipv4地址。
- 测量方式：
  - 端到端延迟：发送端一帧进入编码器的时候打一个时间戳，ffplay播放一帧的时候打一个时间戳，对比两端序号对应的时间戳计算端到端延迟
  - 协议传输延迟：发送子线程发送一帧数据的时候打一个时间戳，client收到数据的时候打时间戳，对比两端收到的数据量大小计算

- 模拟网络测试，在本地局域网利用tc修改丢包，延迟和带宽限制等。

### 字节跳动RTC大作业

- 当前支持单人窗口显示，需要支持4人视频通话
- 分析源代码发现，需要收到的不同流和不同窗口绑定，并通过websocket发送请求
- 主要实现了add track的流序号切换，并根据不同流序号和不同的窗口绑定，最后获取用户信息，保存到JSON指针并发送broadcast请求信息

### 网络拥塞控制

- 蜂窝网络的可用带宽和延迟变化迅速，传统TCP算法无法同时取得高带宽和低延迟。而且当前的时延敏感应用一般有一个延迟上限，因此可以在保证平均延迟低于设定目标延迟的前提最大化网络吞吐量
- 本文提出了CLDCC算法，主要根据估计的实时RTT和RTT梯度判断网络状态，设定延迟上限和延迟下限，如果延迟大于阈值并且延迟梯度为正，则动态减小cwnd。如果延迟小于上限阈值但是延迟梯度为负，表示网络容量可能增大，增加cwnd。如果延迟小于下限，那么则增大cwnd，维持一定的数据在buffer中。
- 结果延迟比bbr好一些，不过存在带宽损失。原因是网络容量增大不多时，可能延迟仍然大于阈值，cwnd没有及时增加

### GCC算法

- 到达滤波器：根据数据帧单向到达时间差值的序列，构建卡尔曼滤波器模型，估计网络容量和瓶颈链路队列大小变化。
- 过载检测器：如果队列变化量超过阈值一定时间，说明网络拥塞，触发过载信号；如果队列变化量小于一个阈值，说明队列排空中，触发underuse；如果队列变化接近0，说明网络稳定，触发normal
- 速率控制器：
  - 如果触发underuse信号，都转入hold状态，直到排空队列为止
  - 如果触发overuse，都转入dec状态，减少速率来阻止拥塞
  - 如果触发normal，切换到hold和increase状态，因为网络队列稳定，可以尝试探测带宽

### BBR算法

- 控制飞行数据为BDP大小，最大带宽和最小RTT的乘积

- 每次ACK交替估计最大带宽和最小RTT

- STARTUP：指数增加发送窗口，直到饱和
- DRAIN：排空STARTUP堆积的数据
- PROBE_BW：8个RTT为一个周期，其中一次RTT增大发送速率，另一次RTT减少速率，探测带宽并保持飞行数据稳定
- PROBE_RTT：10s进入一次，每次发送很少的数据包