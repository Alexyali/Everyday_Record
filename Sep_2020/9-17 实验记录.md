# 9-17 低延迟实验记录

- 测试第一帧数据从yuv采集->server发送->client接收->ffplay播放的时间
- server开始发送时间为刚从FIFO取出该帧数据并准备发送的时刻
- client接收开始时间为刚收到该帧第一个数据的时刻，接收完成时间为收到该帧全部数据的时刻
- ffplay为改进后版本

## 本地测试

- 在enc上运行两个终端，一个开启`my_host_linux`，另一个开启`client`

```
# in enc@enc:~/hwj/quiche/examples
$ ffplay -i cvideopipe
# in enc@enc:~hwj/my_host_linux/build
$ ./my_host_linux
# in enc@enc:~/hwj/quiche/examples
$ ./client 172.16.7.84 2345
```

- 测试结果

|         | yuv采集/ms | server开始发送/ms | client开始接收/ms | client接收完成/ms |
| ------- | ---------- | ----------------- | ----------------- | ----------------- |
| frame 1 | 57620      | 57842             | 57843             | 57856             |
| frame 2 | 57660      | 57867             | 57868             | 57868             |
| frame 3 | 57700      | 57894             | 57894             | 57895             |

- 从一帧采集到一帧传输到客户端，用时为195~236ms
- 第一帧传输用时14ms，其余帧用时在1ms左右

## 局域网测试

- 在enc上运行`my_host_linux`, 在本地电脑运行`client`

```
# in alex@alex:~/Documents/quiche/examples
$ ffplay -i cvideopipe -probesize 32 -flags low_delay -infbuf
# in enc@enc:~hwj/my_host_linux/build
$ ./my_host_linux
# in alex@alex:~/Documents/quiche/examples
$ ./client 172.16.7.84 2345
```

- 测试1

|         | yuv采集 | server开始发送 | client开始接收 | client接收完成 | ffplay播放 |
| ------- | ------- | -------------- | -------------- | -------------- | ---------- |
| frame 1 | 12278   | **12501**      | 12542          | 12562          | 12798      |
| frame 2 | 12318   | **12522**      | 12562          | 12598          | 12843      |
| frame 3 | 12358   | **12552**      | 12598          | 12598          | 12878      |

- 测试2

|         | yuv采集 | server开始发送 | client开始接收 | client接收完成 | ffplay播放 |
| ------- | ------- | -------------- | -------------- | -------------- | ---------- |
| frame 1 | 13031   | **13254**      | 13298          | 13319          | 13566      |
| frame 2 | 13071   | **13282**      | 13319          | 13355          | 13610      |
| frame 3 | 13111   | **13308**      | 13355          | 13355          | 13646      |

- 测试3

|         | yuv采集 | server开始发送 | client开始接收 | client接收完成 | ffplay播放 |
| ------- | ------- | -------------- | -------------- | -------------- | ---------- |
| frame 1 | 3751    | **3981**       | 4025           | 4044           | 4279       |
| frame 2 | 3791    | **4006**       | 4044           | 4071           | 4324       |
| frame 3 | 3832    | **4034**       | 4071           | 4071           | 4362       |

- 结论
  - 从yuv采集到server发送该帧用时在220ms左右；
  - 从server开始发送第一帧到client全部接收用时65ms左右；
  - 从client接收完第一帧到播放用时240ms左右
  - 第一帧的端到端延迟在530ms左右
- 存在的问题：两台电脑的时钟是否同步，相差多少？
- 利用ssh读取服务器时间和本地时间比较，用双向ssh抵消RTT时间，计算出两台机器的时间差
- 在机房拍照显示的延迟显示为650ms左右（enc采集传输，本地播放）