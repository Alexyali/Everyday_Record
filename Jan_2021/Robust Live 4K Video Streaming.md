# Robust Live 4K Video Streaming

## 摘要

为了支持实时4K视频流，需要解决两个问题：

- 适应高度变化且不可预测的无线吞吐量
- 支持有效的4K视频编码技术

为此提出的Jigsaw提供两个解决方法：

- 易于计算的分层视频编码，适应变化的无线链路波动
- 高效的GPU执行，用于视频编码
- 延迟的视频调整和智能调度

## 背景

一般发送端根据网络带宽选择合适的码率发送视频帧。但是无线链路，特别是WiGig的波动特别大，很难提前调整视频质量以适应网络状况。

编码4K视频非常耗时，现有的H264, H265编码器无法满足实时性（FPS30）的要求。端到端延迟包括传输延迟和编解码延迟。实时传输要求一帧编解码延迟为60ms，但是HEVC用时为180ms。

WiGig虽然可以提供高达2.4Gbps的带宽，但是本身容易受外界环境干扰，网络波动大。

因此本文提出点对点的解决方案：

- 易于计算的分层视频编码。允许在低带宽下发送基本层，在高带宽下继续发送增强层
- 基于GPU的快速视频编码和流水线式的编码、传输、解码

- 高效利用WiGig和WiFi

## JIGSAW

### 轻量级分层编码

分层编码可以适应网络的吞吐量波动。本文设计的分层编码器可以快速计算，支持采用GPU的流水线

### 分层编码执行

本文的分层编码器将一个帧视为多个独立块的组合。这允许将一整个帧分解为多个独立的计算并采用GPU流水线

4K视频需要花费大量的时间用于传输。采用流水线编码传输解码可以有效降低延迟。

### 视频传输策略

上层策略是延迟发送决策直到传输，降低吞吐量预测的误差。需要完成的任务如下

- 基于无线网络吞吐量调整视频质量
- 视频帧内调度：选择合适的界面传输数据包
- 视频帧间调度：在发送下一帧前，决定当前帧的发送数据大小

#### 延迟视频速率调整

为了充分利用网络带宽资源并最小化质量的波动，我们尽可能推迟传输决策，并去除吞吐量预测

与其将所有视频包直接推入界面，他们首先被加入到一个首尾相连的缓冲。数据包只有当决策发生后才从这个buffer移出并加入到界面的传输buffer中。为了最小化吞吐量浪费，该模块会丢掉超过ddl的数据包。根据当前估计的吞吐量和界面的队列长度可以计算ddl。

#### 帧内调度

当数据包被推入界面的队列时，无法在超过ddl后丢弃。因此我们只将最小数量的数据包推入队列，维持最大的吞吐量。

可能出现的延迟会造成低层数据包阻塞，但是高层数据包传输。但是我们需要保证层间数据的传输次序。

#### 帧间调度

我们需要决策何时开始传输下一个视频帧。我们有时需要在上一个帧的ddl之前开始传输下一帧，为了保证两个连续帧传输的数据包个数类似，因此不会有太大的质量波动。

## 总结

- 采用分层编码可以适应高度变化的无线带宽
- 为每个视频帧的数据包设置deadline，超时则丢弃
- 采用流水线进行分层编码可以同时进行编码、传输、解码。无需等一帧完全编码再传输。